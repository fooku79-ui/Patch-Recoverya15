name: Patch Recovery (fixed)

on:
  workflow_dispatch:
    inputs:
      IMAGE_URL:
        description: "Fresh signed HTTPS link to recovery/vendor_boot image"
        required: true
      PARTITION_NAME:
        description: "Partition for AVB footer (recovery or vendor_boot)"
        default: "recovery"
      PARTITION_SIZE:
        description: "Exact partition size in bytes (optional). Leave blank to auto-round."
      IMAGE_FILENAME:
        description: "Save-as filename (recovery.img or vendor_boot.img)"
        default: "recovery.img"

jobs:
  patch:
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          set -euxo pipefail
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends curl file cpio gzip lz4 openssl xz-utils zstd

      # >>> NEW: fetch tools if they aren't in the repo <<<
      - name: Ensure magiskboot & avbtool
        run: |
          set -euxo pipefail
          if ! [[ -x ./magiskboot ]]; then
            rm -rf AIK
            git clone --depth=1 https://github.com/osm0sis/Android-Image-Kitchen AIK
            cp AIK/AIK-Linux/bin/magiskboot ./magiskboot
            chmod +x ./magiskboot
          fi
          if ! [[ -x ./avbtool ]]; then
            curl -fL -o avbtool.py https://android.googlesource.com/platform/external/avb/+/refs/heads/master/avbtool.py?format=TEXT
            base64 -d avbtool.py > avbtool
            rm avbtool.py
            chmod +x ./avbtool
          fi
          ./magiskboot --help >/dev/null
          ./avbtool --help >/dev/null

      - name: Download
