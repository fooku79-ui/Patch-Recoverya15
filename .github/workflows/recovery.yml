name: RECOVERY

on:
  workflow_dispatch:
    inputs:
      RECOVERY_URL:
        description: 'RECOVERY URL'
        required: false
        default: ''

env:
  # Fallback if no input is provided
  RECOVERY_URL: https://oshi.at/Rpjg

concurrency:
  group: recovery-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Check Out
        uses: actions/checkout@v4

      - name: Prepare the environment
        run: |
          sudo apt-get update -y
          sudo apt-get install -y git wget lz4 tar openssl python3 python3-pip
          python3 -m pip install --upgrade pip
          python3 -m pip install avbtool

      - name: Resolve RECOVERY_URL
        id: url
        run: |
          # Prefer the workflow input if provided, else use env default
          if [ -n "${{ github.event.inputs.RECOVERY_URL }}" ]; then
            echo "URL=${{ github.event.inputs.RECOVERY_URL }}" >> $GITHUB_OUTPUT
          else
            echo "URL=${RECOVERY_URL}" >> $GITHUB_OUTPUT
          fi

      - name: Fetch image from URL
        run: |
          set -e
          echo "Downloading: ${{ steps.url.outputs.URL }}"
          wget -O recovery.img "${{ steps.url.outputs.URL }}"
          ls -lh

      - name: Patch Process-1
        run: |
          chmod a+x script1.sh magiskboot || true
          ./script1.sh || true

      - name: Patch Process-2
        run: |
          set -e
          chmod a+x script2.sh || true
          ./script2.sh || true
          python3 -m avbtool extract_public_key --key phh.pem --output phh.pub.bin
          python3 -m avbtool add_hash_footer \
            --partition_name recovery \
            --partition_size $(wc -c < recovery.img) \
            --image recovery-patched.img \
            --key phh.pem \
            --algorithm SHA256_RSA4096
          mkdir -p output
          mv recovery-patched.img output/recovery.img
          cd output
          tar cvf fastbootd-recovery.tar recovery.img
          md5sum -t fastbootd-recovery.tar >> fastbootd-recovery.tar
          mv fastbootd-recovery.tar fastbootd-recovery.tar.md5
          ls -lh

      - name: Upload Recovery
        uses: actions/upload-artifact@v4
        with:
          name: Patched-Recovery
          path: ${{ github.workspace }}/output/*.md5
