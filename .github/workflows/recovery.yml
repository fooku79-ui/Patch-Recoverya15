name: RECOVERY

on:
  workflow_dispatch:
    inputs:
      RECOVERY_URL:
        description: 'Direct download URL to recovery.img (presigned Cloudflare/transfer.sh/etc.)'
        required: true
        default: ''

concurrency:
  group: recovery-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Check Out (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Prepare environment
        run: |
          set -euxo pipefail
          sudo apt-get update -y
          # add the missing tools magiskboot/cpio flows need
          sudo apt-get install -y git wget curl lz4 xz-utils cpio tar unzip openssl python3 file
          git lfs install
          git lfs pull

      - name: Verify magiskboot is present
        run: |
          set -euxo pipefail
          test -f magiskboot || (echo "ERROR: magiskboot not found in repo root"; exit 1)
          chmod +x magiskboot

      - name: Shim hardcoded magiskboot path used by script2.sh
        run: |
          set -euxo pipefail
          mkdir -p /home/runner/work/Patch-Recovery/Patch-Recovery
          ln -sf "$GITHUB_WORKSPACE/magiskboot" /home/runner/work/Patch-Recovery/Patch-Recovery/magiskboot

      - name: Get recovery.img
        run: |
          set -euxo pipefail
          URL="${{ github.event.inputs.RECOVERY_URL }}"
          curl -fL --retry 5 --retry-delay 2 --connect-timeout 60 -o recovery.img "$URL"
          [ -s recovery.img ]
          # many scripts expect r.img alongside recovery.img
          cp -f recovery.img r.img

      - name: Ensure signing key exists
        run: |
          set -euxo pipefail
          [ -f phh.pem ] || openssl genrsa -f4 -out phh.pem 4096

      - name: Patch Process-1
        run: |
          set -euxo pipefail
          chmod +x script1.sh || true
          ./script1.sh || true

      - name: Patch Process-2
        run: |
          set -euxo pipefail
          chmod +x script2.sh || true
          ./script2.sh || true

          chmod +x avbtool
          ./avbtool extract_public_key --key phh.pem --output phh.pub.bin
          ./avbtool add_hash_footer \
            --partition_name recovery \
            --partition_size $(wc -c < recovery.img) \
            --image recovery-patched.img \
            --key phh.pem \
            --algorithm SHA256_RSA4096

          mkdir -p output
          mv -f recovery-patched.img output/recovery.img
          (cd output && tar cvf fastbootd-recovery.tar recovery.img)
          (cd output && md5sum -t fastbootd-recovery.tar >> fastbootd-recovery.tar)
          mv -f output/fastbootd-recovery.tar output/fastbootd-recovery.tar.md5

      - name: Upload Recovery
        uses: actions/upload-artifact@v4
        with:
          name: Patched-Recovery
          path: ${{ github.workspace }}/output/*
          if-no-files-found: error
