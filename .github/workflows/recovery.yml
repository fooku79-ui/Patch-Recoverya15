name: Patch Recovery (defensive, self-contained)

on:
  workflow_dispatch:
    inputs:
      IMAGE_URL:
        description: "HTTP/HTTPS URL to recovery/vendor_boot image (fresh signed link)"
        required: true
      PARTITION_NAME:
        description: "Partition for AVB footer (recovery or vendor_boot)"
        default: "recovery"
        required: false
      PARTITION_SIZE:
        description: "Exact partition size in bytes (optional). Leave blank to auto-round."
        required: false
      IMAGE_FILENAME:
        description: "Save-as filename (recovery.img or vendor_boot.img)"
        default: "recovery.img"
        required: false

jobs:
  patch:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          set -euxo pipefail
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            curl ca-certificates python3 file cpio gzip lz4 xz-utils zstd openssl

      - name: Validate inputs & echo
        env:
          IMAGE_URL: ${{ inputs.IMAGE_URL }}
          PARTITION_NAME: ${{ inputs.PARTITION_NAME }}
          PARTITION_SIZE: ${{ inputs.PARTITION_SIZE }}
          IMAGE_FILENAME: ${{ inputs.IMAGE_FILENAME }}
        run: |
          set -euo pipefail
          : "${IMAGE_URL:?INPUT IMAGE_URL is required}"
          : "${PARTITION_NAME:=recovery}"
          : "${IMAGE_FILENAME:=recovery.img}"
          echo "== Inputs =="
          echo "IMAGE_URL=${IMAGE_URL}"
          echo "PARTITION_NAME=${PARTITION_NAME}"
          echo "PARTITION_SIZE=${PARTITION_SIZE:-<auto>}"
          echo "IMAGE_FILENAME=${IMAGE_FILENAME}"

      - name: Ensure magiskboot/avbtool available (use repo, else fallback)
        id: tools
        run: |
          set -euxo pipefail
          ok=1
          if [[ -x ./magiskboot ]]; then
            echo "Using repo magiskboot"
          else
            ok=0
          fi
          if [[ -x ./avbtool ]]; then
            echo "Using repo avbtool"
          else
            ok=0
          fi

          if [[ "$ok" -eq 0 ]]; then
            echo "Tools missing; fetching fallbacksâ€¦"
            rm -rf AIK
            git clone --depth=1 https://github.com/osm0sis/Android-Image-Kitchen AIK
            cp AIK/AIK-Linux/bin/magiskboot ./magiskboot
            chmod +x ./magiskboot
            # Fetch avbtool (AOSP)
            curl -fL -o avbtool.py https://android.googlesource.com/platform/external/avb/+/refs/heads/master/avbtool.py?format=TEXT
            base64 -d avbtool.py > avbtool
            rm avbtool.py
            chmod +x ./avbtool
          fi

          ./magiskboot --help >/dev/null 2>&1 || { echo "magiskboot not runnable"; exit 2; }
          ./avbtool --help >/dev/null 2>&1 || { echo "avbtool not runnable"; exit 2; }

      - name: Download image
        env:
          URL: ${{ inputs.IMAGE_URL }}
          OUT: ${{ inputs.IMAGE_FILENAME }}
        run: |
          set -euxo pipefail
          curl -fL --retry 5 --retry-delay 2 --connect-timeout 60 -o "$OUT" "$URL"
          test -s "$OUT"
          cp -f "$OUT" r.img
          echo "Downloaded $(stat -c%s r.img) bytes"
          file r.img || true
          hexdump -C -n 8 r.img | head -n1 || true

      - name: Make scripts executable (if present)
        run: |
          set -euxo pipefail
          [[ -f script1.sh ]] && chmod +x script1.sh || true
          [[ -f script2.sh ]] && chmod +x script2.sh || true

      - name: Preflight
        run: ./script1.sh
        continue-on-error: false

      - name: Patch + AVB
        env:
          PARTITION_NAME: ${{ inputs.PARTITION_NAME }}
          PARTITION_SIZE: ${{ inputs.PARTITION_SIZE }}
        run: ./script2.sh

      - name: Upload artifact (patched image)
        uses: actions/upload-artifact@v4
        with:
          name: patched-image
          path: |
            recovery-patched.img
            phh.pub.bin
          if-no-files-found: error

    # If anything fails, still capture a debug snapshot
    continue-on-error: false
